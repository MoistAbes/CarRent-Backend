SHOW PROCESSLIST;
SET GLOBAL EVENT_SCHEDULER =ON;

set global log_bin_trust_function_creators=1;

USE rent_car;

DROP FUNCTION IF EXISTS RentDate;

DELIMITER $$


DROP PROCEDURE IF EXISTS CheckRentDates;

DELIMITER $$

CREATE PROCEDURE CheckRentDates()
BEGIN
    DECLARE RNT_ID, DAYS INT;
    DECLARE FINISHED INT DEFAULT 0;
    DECLARE ALL_RENTS CURSOR FOR SELECT rent_id FROM rents;
DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1;
OPEN ALL_RENTS;
WHILE (FINISHED = 0) DO
    FETCH ALL_RENTS INTO RNT_ID;
        IF  (FINISHED = 0) THEN
SELECT DATEDIFF(curdate(), rented_to) FROM rents
WHERE rent_id = RNT_ID
    INTO DAYS;

DELETE FROM rents
WHERE rent_id = RNT_ID
  AND  DAYS = 0;

COMMIT;
end if;
end while;

CLOSE ALL_RENTS;

end $$

CALL CheckRentDates();



CREATE EVENT CHECK_RENT_DATE
    ON SCHEDULE EVERY 1 DAY
    DO CALL CheckRentDates();